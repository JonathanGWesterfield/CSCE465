<html><head><title>4.3. Generating MACs</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="15051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch04lev1sec2.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch04lev1sec4.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top">Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch04lev1sec3"></a>
<h3 id="643999-829" class="docSection1Title">4.3. Generating MACs</h3>
<p class="docText"><a name="iddle1151"></a><a name="iddle1589"></a>A secret key system can be used to generate a cryptographic checksum known as a MAC (message authentication code). A synonym for MAC is MIC (Message Integrity Code). The term MAC seems to be more popular though MIC is sometimes used, for instance in PEM (see &sect;<a class="docLink" href="ch21lev1sec15.html#ch21lev2sec4">21.15.3</a> <span class="docEmphasis">MIC-ONLY or MIC-CLEAR, Public Key Variant</span>). While CBC, CFB, OFB, and CTR, when properly used, all offer good protection against an eavesdropper deciphering a message, none offers good protection against an eavesdropper who already knows the contents of the plaintext message modifying it undetected.</p>
<p class="docText">A standard way for protecting against undetected modifications is to compute the CBC but send only the last block along with the plaintext message. This last block is called the <b><a class="docLink" href="app02.html#gloss01_031">CBC residue</a></b>. In order to compute the CBC residue, you have to know the secret key. If an attacker modifies any portion of a message, the residue will no longer be the correct value (except with probability 1 in 2<sup>64</sup>). And the attacker will not be able to compute the residue for the modified message without knowing the secret key.</p>
<a name="ch04fig11"></a><p><center>
<h5 class="docFigureTitle">Figure 4-11. Cipher Block Chaining Residue</h5>
</center></p><p class="docText">
<img border="0" alt="" id="118095013052" width="500" height="149" src="04fig11.jpg" /></p>
<br />
<p class="docText">In this case, the picture for the recipient of the message is the same as for the sender. The recipient computes the CBC residue based on the plaintext message and sees whether it matches the one sent. If it does, someone who knew the key computed the MAC on that message.</p>
<p class="docText">In many contexts, messages are not secret but their integrity must be ensured. In such contexts it is perfectly appropriate to transmit unencrypted data, plus a CBC residue. Interbank transfers are a traditional example (there may be a desire for secrecy as well, but it is dwarfed by the requirement for accuracy). But more commonly, there is a desire to encrypt messages for both privacy and integrity. This can be done with a single encryption operation if the message is a single block. What is the equivalent transformation on a multiblock message? (Keep reading to find out!)</p>
<a name="ch04lev2sec6"></a>
<h4 id="title-IDAYT0KN" class="docSection2Title">4.3.1. Ensuring Privacy and Integrity Together</h4>
<p class="docText"><a name="iddle1641"></a>To summarize, if we have a message and we want to ensure its privacy, we can CBC-encrypt the message. If we have a message and we want to ensure its integrity, then we can send the CBC residue along with the message. It is natural to assume that if we want to be secure against both modification and eavesdropping that we ought to be able to do something like <a class="docLink" href="#ch04fig12">Figure 4-12</a>.</p>
<a name="ch04fig12"></a><p><center>
<h5 class="docFigureTitle">Figure 4-12. Cipher Block Chaining Encryption plus CBC Residue</h5>
</center></p><p class="docText">
<img border="0" alt="" id="118095013052" width="500" height="139" src="04fig12.jpg" /></p>
<br />
<p class="docText">Well, that can't be right. That consists of sending the CBC encrypted message and just repeating the final block. Anyone tampering with the CBC encrypted message could simply take the value of the final block they wanted to send, and send it twice. So sending the CBC residue in addition to the CBC encrypted message can't enhance security. Maybe simply sending the CBC encrypted message gives privacy and integrity protection. Well, when we say <b><a class="docLink" href="app02.html#gloss01_106">integrity protection</a></b> we mean we'd like the receiving computer to automatically be able to tell if the message has been tampered with. With CBC alone there is no way to detect tampering automatically, since CBC is merely an encryption technique. Any random string of bits will decrypt into something, and the final 64 bits of that random string will be a &quot;correct&quot; CBC residue. So it is easy for anyone to modify the ciphertext, and a computer on the other side will decrypt the result, come up with garbage, but have no way of knowing that the result is garbage. If the message was an English message, and a human was going to look at it, then modification of the ciphertext would probably get detected, but if it is a computer merely loading the bits onto disk, there is no way for the computer to know, with this scheme, that the message has been modified.</p>
<p class="docText">OK, how about computing the CBC residue, attaching that to the plaintext, and then doing a CBC encryption of the concatenated quantity (<a class="docLink" href="#ch04fig13">Figure 4-13</a>)?</p>
<a name="ch04fig13"></a><p><center>
<h5 class="docFigureTitle">Figure 4-13. Cipher Block Chaining Encryption of Message with CBC Residue</h5>
</center></p><p class="docText">
<img border="0" alt="" id="118095013052" width="500" height="153" src="04fig13.jpg" /></p>
<br />
<p class="docText">It turns out that that doesn't work either. The last block is always the encryption of zero, since the <img src="U2295.GIF" border="0" /> of anything with itself is always zero. An extra block that doesn't depend on the message can't offer any integrity protection.</p>
<p class="docText">Let's try one more. Suppose we compute a non-cryptographic checksum (e.g., a CRC) of the blocks of the message, append that to the end, and encrypt the whole thing (<a class="docLink" href="#ch04fig14">Figure 4-14</a>).</p>
<a name="ch04fig14"></a><p><center>
<h5 class="docFigureTitle">Figure 4-14. Cipher Block Chaining Encryption of Message with CRC</h5>
</center></p><p class="docText">
<img border="0" alt="" id="118095013052" width="500" height="153" src="04fig14.jpg" /></p>
<br />
<p class="docText">This almost works. Subtle attacks are known if the CRC is short. Longer non-cryptographic checksums are suspect.</p>
<p class="docText"><a name="iddle1177"></a><a name="iddle1509"></a>So, what can we do? It is generally accepted as secure to protect the privacy of a message with CBC encryption and integrity with a CBC residue as long as the two are computed with different keys. Unfortunately, this requires twice the cryptographic power of encryption alone. Various shortcuts have been proposed and even deployed, but generally they have subtle cryptographic flaws. Whether those flaws are serious depends on the application and the cleverness of the attacker. It's instructive to look at some of the techniques.</p>
<a name="ch04lev2sec7"></a>
<h4 id="title-IDAVY0KN" class="docSection2Title">4.3.2. CBC with a Weak Cryptographic Checksum</h4>
<p class="docText">Jueneman proposed [<a class="docLink" href="biblio01.html#biblio01_086">JUEN84</a>, <a class="docLink" href="biblio01.html#biblio01_087">JUEN85</a>] that since using non-cryptographic checksums inside CBC did not appear to be secure, and since quality cryptographic checksums were expensive to compute, perhaps a &quot;weak&quot; cryptographic checksum inside a CBC would provide good security on the basis that the computational complexity of breaking the weak checksum would be multiplied by the limitations of having to do it under the constraints of the CBC. He proposed a weak cryptographic checksum for this use.</p>
<p class="docText">There is no reason to believe that this approach would not be effective, but it has not caught on. Ironically, Kerberos V4 (see &sect;<a class="docLink" href="ch13lev1sec10.html#ch13lev1sec10">13.10</a> <span class="docEmphasis">Encryption for Integrity Only</span>) uses a variant of his weak <a name="iddle1148"></a><a name="iddle1421"></a>checksum for integrity protection outside of an encrypted message, and there is no evidence that anyone has broken it.</p>
<a name="ch04lev2sec8"></a>
<h4 id="title-IDAO00KN" class="docSection2Title">4.3.3. CBC Encryption and CBC Residue with Related Keys</h4>
<p class="docText">It is generally accepted as secure to compute a message integrity code by computing a CBC residue and then encrypting the message using an independently chosen key. A trick used by Kerberos V5 is to use a modified version of the key for one of the operations. (Switching one bit should be sufficient, but Kerberos instead <img src="U2295.GIF" border="0" />s the key with the constant F0F0F0F0F0F0F0F0<sub>16</sub>. This has the nice properties of preserving key parity and never transforming a non-weak key into a weak key. See &sect;<a class="docLink" href="ch03lev1sec3.html#ch03lev2sec6">3.3.6</a> <span class="docEmphasis">Weak and Semi-Weak Keys</span>.)</p>
<p class="docText">There are no known weaknesses in the approach of having one key be mathematically related to the other (as opposed to simply picking two random numbers for keys), but few advantages either. In general it's no harder to distribute a pair of keys than a single one, and having the keys be mathematically related saves no computational effort. The only advantage of deriving one key from the other is to get both privacy and integrity protection when a mechanism is in place for distributing only a single key.</p>
<a name="ch04lev2sec9"></a>
<h4 id="title-IDAI10KN" class="docSection2Title">4.3.4. CBC with a Cryptographic Hash</h4>
<p class="docText">Another approach is to put a cryptographic hash of the messageÂtypically 128 bitsÂinside, and CBC encrypt the whole thing. This is probably secure (though it hasn't gotten much use or scrutiny, since modern schemes use a keyed hash). It requires two cryptographic passes (just like doing CBC encryption and CBC residue with different keys), but it is more efficient than doing CBC twice if the hash function is faster than the encryption algorithm.</p>
<a name="ch04lev2sec10"></a>
<h4 id="title-IDAU10KN" class="docSection2Title">4.3.5. Offset Codebook Mode (OCB)</h4>
<p class="docText">OCB is one of several modes that get both encryption and integrity protection while making only a single cryptographic pass over the data. This and similar schemes are too new to have stood the test of time, and there are patent issues hanging over them, but it seems likely that one or more will eventually become the standard way to achieving this effect.</p>
<ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="15051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch04lev1sec2.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch04lev1sec4.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>