<html><head><title>16.11. Data Stream Protection</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch16lev1sec10.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch16lev1sec12.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top">Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch16lev1sec11"></a>
<h3 id="title-IDA2JJ1K" class="docSection1Title">16.11. Data Stream Protection</h3>
<p class="docText">TCP's job is to accept a stream of data at the source and deliver that same stream to the process running on top of TCP at the destination. The mechanics of TCP doing its jobÂbreaking the stream into packets, retransmitting lost packets, reordering packetsÂthese are irrelevant to the process running on top of TCP. Protocols such as SSL that run on top of TCP break the data into whatever size chunks are convenient. For instance, SSL sends chunks that might be as large as 16K octets. The chunks will arrive in order (TCP does that), but they may have been broken into smaller pieces, which would certainly happen if the chunk was as large as 16K octets. A chunk cannot be integrity-checked by SSL until all its pieces arrive.</p>
<p class="docText"><a name="iddle1211"></a><a name="iddle1234"></a><a name="iddle1481"></a>With IPsec, however, individual packets are self-contained so that they can be encrypted and integrity-protected independently of other packets in a conversation. This is a performance advantage, since if each packet can be processed individually, it is easier to off-load the cryptographic processing onto an outboard device. It requires no buffering since each packet can be processed immediately.</p>
<p class="docText">This is an argument which is often made (that IPsec can be implemented in an outboard device and SSL can't), but I<sub>2</sub>'m not completely comfortable with that argument. If an IP packet as transmitted by the source is too large, it might get fragmented on some intermediate link. In that case IPsec has the same problem, and can't integrity check a received fragment. It has to wait until all the fragments of the originally transmitted packet are reassembled, just as in the SSL case. And if SSL is careful to send chunks that are small enough that the chunks arrive intact, an outboard device that processed SSL (and implemented TCP as well) could in theory be built.</p>
<p class="docText">With each packet being independently processed, you have to be careful to avoid replay attacks. Therefore you need a sequence number assigned by IPsec. This sequence number has nothing to do with the TCP sequence number. For instance, if TCP is running on top of IPsec, and needs to retransmit a packet, the retransmitted packet will be assigned a different sequence number by IPsec than the originally transmitted packet, and be perceived as a different packet by IPsec.</p>
<p class="docText">You have to make sure that the IPsec-assigned sequence number is not used twice with the same key. So if a conversation is so long that the sequence number would wrap (i.e., reach a maximum value and start again at zero), a new key must be established for that session. And a new key should be established each time a node starts a conversation, since otherwise a packet from a prior conversation could be slipped into the data stream.</p>
<p class="docText">To ensure that two plaintext blocks that are equal will not result in the same ciphertext when encrypted with the same session key, there are various tricks that can be used:</p>
<ul><li><p class="docList">Explicitly put an IV into each packet, and use that IV for encrypting that packet in, for instance, CBC mode. Note that although the final ciphertext block of packet <span class="docEmphasis">n</span> - 1 is a reasonable choice for the IV for packet <span class="docEmphasis">n</span>, since you can't guarantee that packet <span class="docEmphasis">n</span> - 1 is available to IPsec when it is decrypting packet <span class="docEmphasis">n</span>, the IV must appear explicitly in each packet.</p></li><li><p class="docList">Have the IPsec-assigned sequence number be included in the first encryption block, so that the first block of data in each packet to be encrypted is guaranteed to be different for each packet that is encrypted with the same key.</p></li><li><p class="docList">Use a mode such as counter mode (see &sect;<a class="docLink" href="ch04lev1sec2.html#ch04lev2sec5">4.2.5</a> <span class="docEmphasis">Counter Mode (CTR)</span>), using the IPsec-assigned sequence number as the block number.</p></li></ul>
<a href="16051538.html"><img src="pixel.gif" alt="" width="1" height="1" border="0" /></a><ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch16lev1sec10.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch16lev1sec12.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>