<html><head><title>21.16. DES-CBC as MIC Doesn't Work</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch21lev1sec15.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch21lev1sec17.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><a href="16051538.html"><img src="pixel.gif" alt="" width="1" height="1" border="0" /></a>Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch21lev1sec16"></a>
<h3 id="title-IDA2WCFH" class="docSection1Title">21.16. DES-CBC as MIC Doesn't Work</h3>
<p class="docText">Originally, PEM had an additional method of obtaining a MIC on a message, which was the DES-CBC residue. The PEM documentation referred to this form of integrity check as DES-MAC. Ironically, they included this because the MD functions were new and therefore cryptographically suspect, whereas DES CBC residue was used in banking and therefore known to be secure. And it was in the banking context. But not for email. In banking it is used as an integrity check, and has the property that if someone doesn't know the secret key that Alice and Bob share, they cannot modify or forge a message between Alice and Bob. It is instructive to see how something as seemingly straightforward as an integrity check, especially one known to be secure in a highly sensitive application like banking, can have problems. The DES-MAC version of integrity checking has several interesting security problems:</p>
<ul><li><p class="docList">If Alice uses secret key interchange keys and ever sends a message to multiple recipients, say Bob and Ted, then Bob can thereafter send DES-MAC integrity check messages (<span class="docEmphRomanAlt">MIC-CLEAR</span>, <span class="docEmphRomanAlt">MIC-ONLY</span>, or <span class="docEmphRomanAlt">ENCRYPTED</span>) to Ted, claiming to be Alice (and Ted can likewise send such messages to Bob claiming to be Alice). This is true regardless of the choice of integrity check (DES-MAC, MD2, or MD5) Alice chose when she sent the multi-recipient message.</p></li><li><p class="docList">If Alice is using public key technology for interchange keys and uses DES-MAC as the integrity check when sending an <span class="docEmphRomanAlt">ENCRYPTED</span> message to Bob, Bob can thereafter send messages to anyone he wants, claiming to be Alice.</p></li><li><p class="docList">With public key interchange keys, if Alice sends a <span class="docEmphRomanAlt">MIC-CLEAR</span> or <span class="docEmphRomanAlt">MIC-ONLY</span> (as opposed to <span class="docEmphRomanAlt">ENCRYPTED</span>) message to Bob, anyone who eavesdrops on the message can thereafter send messages to anyone she wants, claiming to be Alice.</p></li><li><p class="docList">Suppose Alice, knowing that DES-MAC is not a secure integrity check, never uses it herself. But Ted is happy to accept DES-MAC messages. If Alice sends a message using either MD2 or MD5, someone can use her signature on that message to create a forged message that uses DES-MAC and would appear to come from Alice; Ted would accept such a message as genuine. (Vulnerabilities depend on whether interchange keys are secret or public, and whether the message was encrypted or not. See <a class="docLink" href="ch21lev1sec19.html#ch21qa1q12">Homework Problem 12</a>).</p></li></ul>
<p class="docText">We'll have to describe how DES-MAC is specified in the earlier PEM specification. Suppose Alice is sending a message to Bob and Ted. The algorithm for using DES-MAC as the integrity check is as follows:</p>
<a name="ch21pro01"></a>
<table border="0" class="docText"><tr><td width="25" valign="top"><div class="docText"><b>1. </b></div></td><td><div class="docText">Choose a per-message key (this is the same key PEM would use if PEM was going to encrypt the message).<br /><br /></div></td></tr><tr><td width="25" valign="top"><div class="docText"><b>2. </b></div></td><td><div class="docText">Modify the per-message key by <img src="U2295.GIF" border="0" />ing it with F0F0F0F0F0F0F0F0<sub>16</sub> (to avoid the classic cryptographic flaw described in &sect;<a class="docLink" href="ch04lev1sec3.html#ch04lev2sec6">4.3.1</a> <span class="docEmphasis">Ensuring Privacy and Integrity Together</span>).<br /><br /></div></td></tr><tr><td width="25" valign="top"><div class="docText"><b>3. </b></div></td><td><div class="docText">Compute the 64-bit CBC residue with the modified per-message key.<br /><br /></div></td></tr><tr><td width="25" valign="top"><div class="docText"><b>4. </b></div></td><td><div class="docText">Encrypt the residue. If secret key based interchange keys are used, encrypt the CBC residue with the interchange key associated with Ted, plus encrypt the CBC residue with the interchange key associated with Bob, and send both quantities along with the message. If public key based interchange keys are used, Alice signs the residue with her private RSA key.<br /><br /></div></td></tr></table>
<p class="docText">The problem is that it is possible, given a 64-bit quantity <span class="docEmphasis">x</span> and a DES key <span class="docEmphasis">k</span>, to generate a message <span class="docEmphasis">m</span> such that the CBC residue of <span class="docEmphasis">m</span> with key <span class="docEmphasis">k</span> is <span class="docEmphasis">x</span>. (We'll demonstrate that later in this section.) Let's look at several cases:</p>
<ul><li><p class="docList">Alice sends a <span class="docEmphRomanAlt">MIC-ONLY</span> message to Bob, using public key interchange keys, using DES-MAC as the integrity check. Carol eavesdrops on the message. She can see that it came from Alice. She finds Alice's public key, extracts the signed DES-MAC from the message header, and reverses the signature on the DES-MAC, thereby retrieving the DES-MAC of the message. Carol now knows the quantity <span class="docEmphasis">x</span> (the DES-MAC) and the quantity <span class="docEmphasis">y</span>, which is Alice's signature on <span class="docEmphasis">x</span>. As we said, she can invent any key <span class="docEmphasis">k</span> and construct a message <span class="docEmphasis">m</span> with DES-MAC <span class="docEmphasis">x</span> (using key <span class="docEmphasis">k</span>). She can then send <span class="docEmphasis">m</span> to anyone she wants, say Ted, and claim that the message was from Alice, because she'll include <span class="docEmphasis">y</span> as the signed DES-MAC for <span class="docEmphasis">m</span>.</p></li><li><p class="docList">Suppose instead that Alice sends an encrypted message to Bob. In this case only Bob knows the quantities <span class="docEmphasis">x</span> (the DES-MAC of the message) and <span class="docEmphasis">y</span> (Alice's signature on <span class="docEmphasis">x</span>) because PEM specifies that if the message is encrypted, the integrity check is encrypted with the key used to encrypt the per-message key. But that means that Bob can now send messages claiming to be Alice, just like any eavesdropper could have done in the previous example.</p></li><li><p class="docList">Alice sends a message with DES-MAC integrity check to both Bob and Ted, using secret key interchange keys. So she shares a key <span class="docEmphasis">K</span><sub>AB</sub> with Bob, and shares a key <span class="docEmphasis">K</span><sub>AT</sub> with Ted. The DES-MAC is included twice, once encrypted with <span class="docEmphasis">K</span><sub>AB</sub> and once encrypted with <span class="docEmphasis">K</span><sub>AT</sub>. Furthermore the per-message key <span class="docEmphasis">k</span> is sent twice, once encrypted with <span class="docEmphasis">K</span><sub>AB</sub> and once encrypted with <span class="docEmphasis">K</span><sub>AT</sub>. An eavesdropper cannot discover the DES-MAC of the message even if the message isn't encryptedÂshe can't compute it because she doesn't know <span class="docEmphasis">k</span>, and she can't decrypt the encrypted DES-MAC because she doesn't know either <span class="docEmphasis">K</span><sub>AB</sub> or <span class="docEmphasis">K</span><sub>AT</sub>. However, Bob does know the DES-MAC <span class="docEmphasis">x</span>, and can see <span class="docEmphasis">K</span><sub>AT</sub>{<span class="docEmphasis">x</span>}. He also knows <span class="docEmphasis">k</span> and <span class="docEmphasis">K</span><sub>AT</sub>{<span class="docEmphasis">k</span>}. So after receiving this message from Alice, Bob can construct a message <span class="docEmphasis">m</span> with CBC residue <span class="docEmphasis">x</span>, send it to Ted using per-message key <span class="docEmphasis">k</span>, claim that Alice is sending it, and send <span class="docEmphasis">K</span><sub>AT</sub>{<span class="docEmphasis">k</span>} as the encrypted per-message key and <span class="docEmphasis">K</span><sub>AT</sub>{<span class="docEmphasis">x</span>} as the encrypted DES-MAC.</p></li><li><p class="docList">Alice sends a message with MD5 integrity check to Bob and Ted, using secret key interchange keys. PEM specifies that each of the two 64-bit halves of the MD5 is encrypted with the interchange key of each recipient. Let's say that the halves are <span class="docEmphasis">x</span><sub>1</sub> and <span class="docEmphasis">x</span><sub>2</sub>. So Alice will send <span class="docEmphasis">K</span><sub>AT</sub>{<span class="docEmphasis">x</span><sub>1</sub>} and <span class="docEmphasis">K</span><sub>AB</sub>{<span class="docEmphasis">x</span><sub>1</sub>} as well as <span class="docEmphasis">K</span><sub>AT</sub>{<span class="docEmphasis">x</span><sub>2</sub>} and <span class="docEmphasis">K</span><sub>AB</sub>{<span class="docEmphasis">x</span><sub>2</sub>}. Now even though Alice wasn't using DES-MAC, Bob knows a 64-bit quantity (say <span class="docEmphasis">x</span><sub>2</sub>) and what that quantity looks like when encrypted with <span class="docEmphasis">K</span><sub>AT</sub>. He also knows the per-message key <span class="docEmphasis">k</span> and <span class="docEmphasis">K</span><sub>AT</sub>{<span class="docEmphasis">k</span>}. So Bob can construct a message <span class="docEmphasis">m</span> with CBC-residue <span class="docEmphasis">x</span><sub>2</sub> and send it to Ted using per-message key <span class="docEmphasis">k</span>, claiming that it was from Alice and that DES-MAC was the integrity check used. Note that any of the quantities <span class="docEmphasis">x</span><sub>1</sub>, <span class="docEmphasis">x</span><sub>2</sub>, or <span class="docEmphasis">k</span> could have been chosen to be the per-message key and/or the DES-MAC of the forged message.</p></li></ul>
<p class="docText">Now we'll show how, given a 64-bit value <span class="docEmphasis">r</span> and a key <span class="docEmphasis">k</span>, it is possible for Carol to construct a message <span class="docEmphasis">m</span> with <span class="docEmphasis">r</span> as the CBC residue (using key <span class="docEmphasis">k</span>) (see <a class="docLink" href="#ch21fig03">Figure 21-3</a>). Carol can actually construct any message she wants. The only constraint on the message is that somewhere inside the message there has to be a 64-bit block (8 characters) that must be filled with a value determined only by the rest of the message and <span class="docEmphasis">r</span> and <span class="docEmphasis">k</span>.</p>
<a name="ch21fig03"></a><p><center>
<h5 class="docFigureTitle">Figure 21-3. Generating a Message with a Given CBC Residue</h5>
</center></p><p class="docText">
<img border="0" alt="" width="500" height="149" src="21fig03.jpg" /></p>
<br />
<p class="docText">Let's assume that there's one 8-byte block of the message, say <span class="docEmphasis">m</span><sub>4</sub>, that Carol can fill with &quot;garbage&quot; without suspicion. She constructs the message she wants in the remaining plaintext blocks. She will be sending a message to Ted, signed by Alice. Ted might think it strange to have 8 bytes of crud in the middle of the message, but maybe Carol can cleverly write the message so that somewhere inside the message she says something like, <span class="docEmphasis">Hey, did I tell you about how I fixed my porch this weekend? It went well until I hit my thumb with the hammer. Then I said, &quot;@f#!Ruoe&quot;! Now, back to business ...</span></p>
<p class="docText">Alternatively, mailers are so wonderfully user-friendly that cybercrud appears in them all the time. PEM headers certainly are ugly and would be ignored by a human. Even non-PEM messages often contain obscure-looking headers and postmarks. If Carol were to embed arbitrary cybercrud there it probably would not create suspicion.</p>
<p class="docText">Anyway, Carol works backwards from <span class="docEmphasis">r</span>. DES is reversible, so she can decrypt <span class="docEmphasis">r</span> and <img src="U2295.GIF" border="0" /> that value with <span class="docEmphasis">m</span><sub>6</sub> to discover what <span class="docEmphasis">c</span><sub>5</sub> should be. She then decrypts <span class="docEmphasis">c</span><sub>5</sub> and <img src="U2295.GIF" border="0" />s it with <span class="docEmphasis">m</span><sub>5</sub>, to compute <span class="docEmphasis">c</span><sub>4</sub>.</p>
<p class="docText">Also, she works forward. She can encrypt <span class="docEmphasis">m</span><sub>1</sub> to get <span class="docEmphasis">c</span><sub>1</sub>. Then she <img src="U2295.GIF" border="0" />s <span class="docEmphasis">c</span><sub>1</sub> with <span class="docEmphasis">m</span><sub>2</sub> and encrypts the result to get <span class="docEmphasis">c</span><sub>2</sub> and then <img src="U2295.GIF" border="0" />s <span class="docEmphasis">c</span><sub>2</sub> with <span class="docEmphasis">m</span><sub>3</sub> and encrypts the result to get <span class="docEmphasis">c</span><sub>3</sub>. Now she has gotten to where the two ends of the computation meet. She <img src="U2295.GIF" border="0" />s <span class="docEmphasis">c</span><sub>3</sub> with the decryption of <span class="docEmphasis">c</span><sub>4</sub> to get <span class="docEmphasis">m</span><sub>4</sub>.</p>
<p class="docText">Why don't the other types of MIC have the problems we've described in this section? The reason is that with message digests it is impossible for Carol to come up with another message with a particular message digest. So the PEM designers simply removed DES-MAC as a permissible integrity check.</p>
<a href="16051538.html"><img src="pixel.gif" alt="" width="1" height="1" border="0" /></a><ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch21lev1sec15.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch21lev1sec17.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>