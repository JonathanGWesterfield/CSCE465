<html><head><title>18.6. Phase-2 IKE: Setting up IPsec SAs</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch18lev1sec5.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch18lev1sec7.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top">Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch18lev1sec6"></a>
<h3 id="title-IDANY3MI" class="docSection1Title">18.6. Phase-2 IKE: Setting up IPsec SAs</h3>
<p class="docText">Phase-2 IKE is known as &quot;Quick Mode&quot;. It is a 3-message protocol that negotiates parameters for the phase-2 SA, including cryptographic parameters and the SPI with which the phase-2 SA will be identified.</p>
<a name="ch18fig12"></a><p><center>
<h5 class="docFigureTitle">Protocol 18-12. IKE Quick Mode</h5>
</center></p><p class="docText">
<img border="0" alt="" width="500" height="236" src="18fig12.jpg" /></p>
<br />
<p class="docText">The phase-2 exchange sends nonces and other information which get shuffled into the SKEY-SEED computed in the IKE SA to compute integrity and encryption keys for the IPsec SA, It can optionally do a Diffie-Hellman exchange if it would like PFS for the IPsec SA (the IKE SA might be much longer lived than the IPsec SA, and its keying material might be stolen after the IPsec SA concludes). There is no way to negotiate Diffie-Hellman parameters in the phase-2 exchange. If her choice of Diffie-Hellman parameters is unacceptable, Bob will complain. One would think they might as well just use the Diffie-Hellman group chosen for phase 1, but phase 2 does have the initiator specify the group, so IKE allows phase 2 to use a different group.</p>
<p class="docText">All messages in Quick Mode are encrypted with the Phase 1 SA's encryption key K<sub>enc</sub> (which IKE calls SKEYID_e) and integrity protected with the Phase 1 SA's integrity key K<sub>int</sub> (which IKE calls SKEYID_a).</p>
<p class="docText">This exchange agrees upon parameters, and encryption and/or integrity keys for each direction, to be used by the created IPsec SA.</p>
<p class="docText">Now we'll talk about the details. Each message starts with the following, unencrypted:</p>
<ul><li><p class="docList">X, which is the pair of cookies generated in phase 1, and</p></li><li><p class="docList">Y, a 32-bit number chosen by the phase-2 initiator to distinguish this phase-2 session setup from perhaps many phase-2 sessions simultaneously being set up within the same phase-1 session. There are two problems with this design. One is the replay problem (see &sect;<a class="docLink" href="ch18lev1sec5.html#ch18lev2sec7">18.5.7</a> <span class="docEmphasis">Message IDs</span>). The other is that it is possible for Bob and Alice to each initiate a phase-2 exchange, and choose the same value for Y, which would create confusion. The IKE specification notes this possibility but remarks that it's &quot;unlikely&quot;. But they could easily have reduced the probability of Y-value collisions from &quot;unlikely&quot; to zero by having a convention whereby the initiator of the phase 1 exchange chooses odd Y's and the responder of the phase 1 exchange chooses even Y's.</p></li></ul>
<p class="docText">The rest of each message (following X and Y) is encrypted, using SKEYID_e, and integrity protected using SKEYID_a. The IV for the first message is the final ciphertext block of the last message of phase 1 hashed with Y. The IVs for the other messages in the exchange consist of the final ciphertext block of the previous phase 2 message. The other fields in the phase 2 exchange are:</p>
<ul><li><p class="docList">authenticator (an integrity check on the message using SKEYID_a)</p></li><li><p class="docList">proposed crypto parameters (message 1), and accepted crypto parameters (message 2)</p></li><li><p class="docList">nonces in messages 1 and 2</p></li><li><p class="docList">optionally Diffie-Hellman values in messages 1 and 2</p></li><li><p class="docList">optionally a description of the traffic to be sent (see &sect;<a class="docLink" href="ch18lev1sec5.html#ch18lev2sec9">18.5.9</a> <span class="docEmphasis">Traffic Selectors</span>)</p></li></ul>
<ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch18lev1sec5.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch18lev1sec7.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>