<html><head><title>19.9. Version Numbers</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="16051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch19lev1sec8.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch19lev1sec10.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top">Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch19lev1sec9"></a>
<h3 id="643999-902" class="docSection1Title">19.9. Version Numbers</h3>
<p class="docText">The SSL/TLS designers had a strange idea about how to use a version number field. SSLv2 has a 2-octet field known as <span class="docEmphSmaller">VERSION NUMBER</span> which is set to 0.2 (0 in the high-order octet, 2 in the low-order octet). SSLv3 has a field known as <span class="docEmphSmaller">VERSION NUMBER</span> which is set 3.0 (3 in the high-order octet, 0 in the low-order octet). TLS has a field known as <span class="docEmphSmaller">VERSION NUMBER</span> which is set to 3.1 (3 in the high-order octet, 1 in the low-order octet). SSLv3 moved the <span class="docEmphSmaller">VERSION NUMBER</span> field! So you can't distinguish v2 and v3 messages by looking at the <span class="docEmphSmaller">VERSION NUMBER</span> field. An SSLv3 client cannot send an SSLv3 <span class="docEmphasis">client-hello</span> message, unless it knows somehow that the server it is contacting speaks SSLv3, since an SSLv2 server will misparse the packet and get confused. So it sends a v2 <span class="docEmphRomanAlt">client-hello</span> message, but fills in the <span class="docEmphSmaller">VERSION NUMBER</span> field as 3.0.</p>
<p class="docText">SSLv2 didn't specify what you do if you see a higher version number. Many implementations simply ignore the version number (that means they parse the message, not worrying if the <span class="docEmphSmaller">VERSION NUMBER</span> field indicates a higher version of the protocol than they support). SSLv3 and TLS implementations depend on this behavior. This implies of course that everything the client needs to say can be expressed in v2 format, which is true, and which makes you wonder why they needed to change the format for v3.</p>
<p class="docText">So an SSLv2 server that receives a message with a higher version number than it supports happily parses the message, assuming that nobody would have changed the message format in a later version of the protocol (even though the designers did just that for version 3!).</p>
<p class="docText">The designers of the higher versions were lucky that it is possible to distinguish a v2 message from a v3 or TLS message (if they hadn't moved the <span class="docEmphSmaller">VERSION NUMBER</span> field it would have been easy). For instance, it happens that the first octet of the v2 <span class="docEmphasis">client-hello</span> will be greater than 128, and the first octet of the v3 <span class="docEmphasis">client-hello</span> will be something between 20 and 23. There might indeed be other octets in the message that would distinguish v2 and v3. The spec doesn't say how to differentiate the two, which is dangerous, since it's conceivable someone might, in a future version, change the format again, and assume that implementations are differentiating versions based on the first octet when in fact they're looking elsewhere.</p>
<p class="docText">So SSLv3 clients send an SSLv2 <span class="docEmphasis">client-hello</span> message, as long as there might be a server out there still speaking SSLv2. Which means that in reality the SSLv3 <span class="docEmphasis">client-hello</span> never gets used, (except when resuming a session with a server that the client discovered was SSLv3). In the SSLv2 <span class="docEmphasis">client-hello</span> message, the v3 client puts the value 3.0. If the server speaks v3, it will respond with a v3 message. However, if the server is v2, it thinks its own version number is 0.2, and will interpret version 3.0 as 3x256+0, or 768. Wow! It never occurs to the SSLv2 server that the message might have gotten redesigned in between version 2 and version 768!</p>
<p class="docText">Suppose a v3 client somehow knew it was talking to a v3 server. Then it would be able to send a v3 <span class="docEmphasis">client-hello</span>. But that means that the server had better be able to tell the difference between a v2 <span class="docEmphasis">client-hello</span> and a v3 <span class="docEmphasis">client-hello</span>, since v3 clients that know that the server speaks v3 will send v3 <span class="docEmphasis">client-hello</span>s, while v2 clients or v3 clients that don't know what version the server speaks will send v2 <span class="docEmphasis">client-hello</span>s.</p>
<p class="docText">How does an SSLv3 client encode what it would like in an SSLv2 <span class="docEmphasis">client-hello</span>? Luckily there's nothing in the SSLv3 <span class="docEmphasis">client-hello</span> that can't easily be encoded in an SSLv2 <span class="docEmphasis">client-hello</span>. One interesting field is <span class="docEmphSmaller">CIPHER SUITE</span>, which had a 3-octet encoding in SSLv2 and a 2-octet encoding in SSLv3. It's easy to fit a 2-octet value into a 3-octet field. The reverse would have been more challenging. (See section &sect;<a class="docLink" href="ch19lev1sec10.html#ch19lev1sec10">19.10</a> <span class="docEmphasis">Negotiating Cipher Suites</span>.)</p>
<p class="docText">It would be nice if the SSLv3 designers learned their lesson about version numbers based on the kludginess of v2/v3 interoperability, and had a fixed place in the packet for version number, and specified that a node that didn't support the higher version number should not attempt to parse the packet further but instead send back a message specifying the largest version it supported. But SSLv3 (and TLS) do the same thing SSLv2 did. If they see a higher version number, they happily parse the packet as if all future messages will be compatible with their version.</p>
<p class="docText">SSLv2 does not integrity-protect the <span class="docEmphasis">client-hello</span>. Therefore it's possible for an active attacker to modify a v3 client's v2 <span class="docEmphasis">client-hello</span> by changing the version number from 768 (SSLv3) or 769 (TLS) to 2. SSLv3 and TLS have a cute method of detecting this tampering despite the fact that the SSLv2 handshake doesn't explicitly protect against it. SSLv3 and TLS specify 3s as the least significant eight octets of the PKCS #1 padding (see &sect;<a class="docLink" href="ch06lev1sec3.html#ch06lev3sec7">6.3.6.1</a> <span class="docEmphasis">Encryption</span>) when the client sends the pre-master secret (<span class="docEmphasis">S</span>) to the server.</p>
<p class="docText">So, if a v3 or TLS server receives a <span class="docEmphasis">client-hello</span> with version 2 and with the <span class="docEmphasis">S</span> value padding having 3s in the least significant eight octets, it breaks the connection and should issue an error. There is a 1 in 2<sup>64</sup> chance that a v2 client might just happen to choose padding with the least significant eight octets being 3s, in which case its connection will get mysteriously rejected.</p>
<ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="16051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch19lev1sec8.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch19lev1sec10.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>