<html><head><title>17.1. Overview of IPsec</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch17.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch17lev1sec2.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top"><a href="16051538.html"><img src="pixel.gif" alt="" width="1" height="1" border="0" /></a>Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch17lev1sec1"></a>
<h3 id="title-IDAHNHRX" class="docSection1Title">17.1. Overview of IPsec</h3>
<p class="docText">The part of IPsec that we cover in this chapter assumes that two nodes already have a shared session key, which might have been configured manually, or established through IKE.</p>
<p class="docText">Since Bob might be receiving IPsec-protected packets from many sources, maybe even different processes using the same source IP address, there has to be a way for Bob to know which cryptographic key and which algorithms to use to process the packet. This is done by inserting an IPsec header (AH and/or ESP) into the IP packet which tells Bob to which security association the packet belongs (see &sect;<a class="docLink" href="#ch17lev2sec1">17.1.1</a> <span class="docEmphasis">Security Associations</span>). IPsec works with IPv4 or with IPv6.</p>
<a name="ch17lev2sec1"></a>
<h4 id="title-IDA3NHRX" class="docSection2Title">17.1.1. Security Associations</h4>
<p class="docText">An IPsec security association (SA) is a cryptographically protected connection. Associated with each end of the SA is a cryptographic key and other information such as the identity of the other end, the sequence number currently being used, and the cryptographic services being used (e.g., integrity only, or encryption + integrity, and which cryptographic algorithms should be used). The SA is considered unidirectional, so a conversation between Alice and Bob will consist of two SAs, one in each direction.</p>
<p class="docText">The IPsec header includes a field known as the <span class="docEmphRoman"><a class="docLink" href="app02.html#gloss01_211"><span class="docEmphSmaller">SPI</span></a></span> (<span class="docEmphSmaller">SECURITY PARAMETER INDEX</span>) which identifies the security association, allowing Alice to look up the necessary information (such as the cryptographic key) in her SA database. The SPI value is chosen by the destination (Bob), so it would seem as though the SPI alone should allow Bob to know the SA, since Bob can ensure that the SPI is unique with respect to all the sources that Bob has SAs with. But it is possible for Bob to also be receiving multicast data, in which case Bob would not have chosen the SPI, and it might be equal to one that Bob already assigned. Therefore the SA is defined by both the SPI and the destination address. (The destination address of a packet received by Bob will be <span class="docEmphRomanAlt">Bob</span> for unicast, or a group address if it's multicast.) Furthermore, IPsec allows the same SPI values to be assigned to different SAs if one SA is using AH and one is using ESP, so the SA is defined by the triple &lt;SPI, destination address, flag for whether it's AH or ESP&gt;.</p>
<a name="ch17lev2sec2"></a>
<h4 id="title-IDAAPHRX" class="docSection2Title">17.1.2. Security Association Database</h4>
<p class="docText">A system implementing IPsec keeps a security association database. When transmitting to IP destination <span class="docEmphasis">X</span>, the transmitter looks up <span class="docEmphasis">X</span> in the security association database, and that entry will tell it how to transmit to <span class="docEmphasis">X</span>, i.e., it will provide the SPI, the key, the algorithms, the sequence number, etc. When receiving an IP packet, the SPI of the received packet is used to find the entry in the security association database that will tell the receiver which key, sequence number, etc., to use to process the packet.</p>
<a name="ch17lev2sec3"></a>
<h4 id="title-IDATPHRX" class="docSection2Title">17.1.3. Security Policy Database</h4>
<p class="docText">Just as firewalls are configured with tables telling them what type of traffic to allow based on information such as the IP header source and destination addresses and TCP ports, IPsec is assumed to have access to a similar database specifying which types of packets should be dropped completely, which should be forwarded or accepted without IPsec protection, and which should be protected by IPsec, and if protected, whether they should be encrypted and/or integrity-protected. Decisions could, in theory, be based on any fields in the packet, e.g., source IP address, destination IP address, protocol type in the IP header, and layer 4 (TCP or UDP) ports.</p>
<a name="ch17lev2sec4"></a>
<h4 id="title-IDACQHRX" class="docSection2Title">17.1.4. AH and ESP</h4>
<p class="docText">AH (Authentication Header, defined in RFC 2402) and ESP (Encapsulating Security Payload, defined in RFC 2406) are the two types of IPsec headers. AH provides integrity protection only. ESP provides encryption and/or integrity protection.</p>
<p class="docText">Given that ESP optionally provides integrity protection (in addition to optional encryption), it's natural to wonder why AH is needed. In fact many people argue (and we concur) that AH is not necessary. The integrity protection provided by ESP and AH are not identical, however. Both provide <a name="iddle2091"></a><a name="iddle2101"></a>integrity protection of everything beyond the IP header, but AH provides integrity protection for some of the fields inside the IP header as well. See &sect;<a class="docLink" href="#ch17lev2sec6">17.1.6</a> <span class="docEmphasis">Why Protect the IP Header?</span>. AH can't protect all of the fields, because some of them are intended to be modified by routers (see &sect;<a class="docLink" href="ch17lev1sec3.html#ch17lev2sec11">17.3.1</a> <span class="docEmphasis">Mutable, Immutable</span>).</p>
<p class="docText">There is one feature that AH provides that ESP does not. Firewalls and routers sometimes look at fields such as layer 4 ports in order to do packet filtering, content screening, or differential queuing. If everything beyond the header is encrypted (as it would be with ESP, if ESP is encrypting), then firewalls and routers are not able to look at those fields. One could use ESP for integrity only, but it would be impossible for a firewall or router to know whether an ESP-protected packet was encrypted or not. The source and destination knowÂit's either manually configured into the SA or negotiated through IKE. But there's nothing in the packet header that tells a router or firewall whether a packet is encrypted.</p>
<p class="docText">This &quot;feature&quot; of having routers and firewalls look at the TCP ports can only be used with unencrypted IP traffic, and many security advocates argue that IPsec should always be encrypting the traffic. Fields such as TCP ports should perhaps be hidden to avoid divulging information such as which applications are running. Firewalls base decisions on the port fields, but a malicious user can disguise any traffic to fit the firewall's policy database (e.g., if the firewall allows HTTP, then run all protocols on top of HTTP).</p>
<a name="ch17lev2sec5"></a>
<h4 id="title-IDAURHRX" class="docSection2Title">17.1.5. Tunnel, Transport Mode</h4>
<p class="docText">The IPsec specification talks about two &quot;modes&quot; of applying IPsec protection to a packet. <span class="docEmphStrong">Transport mode</span> refers to adding the IPsec information between the IP header and the remainder of the packet. <span class="docEmphStrong">Tunnel mode</span> refers to keeping the original IP packet intact and adding a new IP header and IPsec information (ESP or AH) outside.</p>
<a name="ch17fig01"></a><p><center>
<h5 class="docFigureTitle">Figure 17-1. Transport Mode and Tunnel Mode</h5>
</center></p><p class="docText"><div class="v1"><a target="_blank" href="17fig01_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="105" src="17fig01.jpg" /></p>
<br />
<p class="docText">Transport mode is most logical when IPsec is being applied end-to-end. A common use of tunnel mode is firewall to firewall, or endnode to firewall, where the data is only protected along part of the path between the endpoints. Suppose two firewalls establish an encrypted tunnel to each other across the Internet (see <a class="docLink" href="#ch17fig02">Figure 17-2</a>). They treat the tunnel as if it is an ordinary, trusted link. In order to forward packets across that link, F1 adds an IP header with destination=F2. When A launches an IP packet to destination B, it will have, in the IP header, source=A and destination=B.</p>
<a name="ch17fig02"></a><p><center>
<h5 class="docFigureTitle">Figure 17-2. IPsec, tunnel mode, between firewalls</h5>
</center></p><p class="docText">
<img border="0" alt="" width="500" height="124" src="17fig02.jpg" /></p>
<br />
<p class="docText">When F1 forwards the packet to F2 across the encrypted tunnel, it will use IPsec tunnel mode. F1 will not modify the inner header, other than doing what any router would do when forwarding a packet, such as decrementing the hop count. The outer IP header added by F1 will have source=F1 and destination=F2. The inner header will be unmodified by the routers along the path between F1 and F2. Those routers will only look at the outer IP header.</p>
<p class="docText">Transport mode is not strictly necessary, since tunnel mode could be used instead. Tunnel mode just uses more header space since there will be two IP headers.</p>
<p class="docText">The same packet might have multiple layers of IPsec (ESP and/or AH) headers, and might be multiply-encrypted (see <a class="docLink" href="#ch17fig03">Figure 17-3</a>). Suppose A and B are talking with an encrypted end-to-end connection. Their packets will contain an ESP header. When F1 forwards it across the tunnel to F2, F1 takes the entire packet (including the IP+ESP header) and adds its own IP + ESP header. F1 encrypts the entire packet it received, including the IP header, with the key that F1 shares with F2.</p>
<a name="ch17fig03"></a><p><center>
<h5 class="docFigureTitle">Figure 17-3. Multiply encrypted IP packet</h5>
</center></p><p class="docText"><div class="v1"><a target="_blank" href="17fig03_alt.jpg">[View full size image]</a></div><img border="0" alt="" width="500" height="39" src="17fig03.jpg" /></p>
<br />
<p class="docText">Tunnel mode is essential between firewalls in order to preserve the original source and destination addresses; and as we said earlier, tunnel mode can be used instead of transport mode at the expense of adding a new IP header. Given that IPsec is too complex, many have argued that getting rid of transport mode would be one way of simplifying IPsec. But transport mode is such a small piece of the complexity of IPsec that we don't feel it's worth worrying about. Far more useful would be to get rid of AH and most of IKE.</p>
<a name="ch17lev2sec6"></a>
<h4 id="title-IDAMVHRX" class="docSection2Title">17.1.6. Why Protect the IP Header?</h4>
<p class="docText"><a name="iddle1192"></a><a name="iddle1439"></a><a name="iddle1466"></a><a name="iddle1483"></a><a name="iddle1484"></a>AH advocates claim AH is needed because it protects the IP header. It is unclear why it is necessary to protect the IP header. If it were necessary, this could be provided by ESP in tunnel mode. Intermediate routers cannot enforce AH's integrity protection, because they would not know the session key for the Alice-Bob security association. So AH can at best be used by Bob to check that the IP header was received as launched by Alice.</p>
<a href="16051538.html"><img src="pixel.gif" alt="" width="1" height="1" border="0" /></a><ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch17.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch17lev1sec2.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>