<html><head><title>17.3. AH (Authentication Header)</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="16051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch17lev1sec2.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch17lev1sec4.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top">Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch17lev1sec3"></a>
<h3 id="643999-863" class="docSection1Title">17.3. AH (Authentication Header)</h3>
<p class="docText">The AH header provides authentication only (not encryption), and is defined in RFC 2402. It looks like</p>
<p><table cellspacing="0" frame="void" rules="none" cellpadding="5"><colgroup align="right" span="2"><col width="50"></col><col width="400"></col></colgroup><thead></thead><tr><td class="docTableCell" align="right" valign="top"><p class="docText"># octets</p></td><td class="bottomBorder" align="right" valign="top">&nbsp;</td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">1</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">next header</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">1</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">payload length</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">2</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">unused</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">4</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">SPI (Security Parameter Index)</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">4</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">sequence number</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">variable</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">authentication data</span></p></td></tr></table></p><br />
<p class="docText">This is the same format as IPv6 extension headers, which all start with <span class="docEmphSmaller">NEXT HEADER</span> and <span class="docEmphSmaller">PAYLOAD LENGTH</span> (which gives the length of the AH header), except, as we said in the previous section, AH's <span class="docEmphSmaller">PAYLOAD LENGTH</span> is in different units than the equivalent field in an IPv6 extension header. AH is intended not only to protect the data, but the IP header as well. In IPv4, the AH header must be a multiple of 32 bits, and in IPv6 it must be a multiple of 64 bits. So the <span class="docEmphSmaller">AUTHENTICATION DATA</span> field must be an appropriate size to make the header size be the right length.</p>
<p class="docText">Some integrity checks require the data to be a multiple of some block size. If the data is not a multiple of the block size, then AH is computed as if the data were padded to the proper length with <span class="docEmphRomanAlt">0</span>s, but the 0s are not transmitted.</p>
<p class="docText">The fields in AH are</p>
<ul><li><p class="docList"><span class="docEmphSmaller">NEXT HEADER</span>. Same as <span class="docEmphSmaller">PROTOCOL</span> field in IPv4. For example, if TCP follows the AH header, then <span class="docEmphSmaller">NEXT HEADER</span> is 6.</p></li><li><p class="docList"><span class="docEmphSmaller">PAYLOAD LENGTH</span>. The size of the AH header in 32-bit chunks, not counting the first 8 octets.</p></li><li><p class="docList"><span class="docEmphSmaller">SPI</span>. Discussed in &sect;<a class="docLink" href="ch17lev1sec1.html#ch17lev2sec1">17.1.1</a> <span class="docEmphasis">Security Associations</span>.</p></li><li><p class="docList"><span class="docEmphSmaller">SEQUENCE NUMBER</span>. The sequence number has nothing to do with TCP's sequence number. This sequence number is assigned by AH and used so that AH can recognize replayed packets and discard them. So, for example, if TCP retransmits a packet, AH will just treat it like a new packet and give it the next sequence number. AH will not know (or care) that this is a retransmitted TCP packet.</p></li><li><p class="docList"><span class="docEmphSmaller">AUTHENTICATION DATA</span>. This is the cryptographic integrity check on the data.</p></li></ul>
<a name="ch17lev2sec11"></a>
<h4 id="title-IDAW2V4R" class="docSection2Title">17.3.1. Mutable, Immutable</h4>
<p class="docText">Some fields in the IP header get modified by routers, so they can't be included in AH's end-to-end integrity check. For example, the <span class="docEmphRoman"><a class="docLink" href="app02.html#gloss01_233">TTL</a></span> field must be decremented by every router. The immutable fields are the ones that the AH designers do not believe should ever legitimately be modified in transit.</p>
<p class="docText">The IPv4 AH defines the mutable fields as <span class="docEmphSmaller">TYPE OF SERVICE</span>, <span class="docEmphSmaller">FLAGS</span>, <span class="docEmphSmaller">FRAGMENT OFFSET</span>, <span class="docEmphSmaller">TIME TO LIVE</span>, and <span class="docEmphSmaller">HEADER CHECKSUM</span>.</p>
<p class="docText">Some of the choices for which fields are considered mutable are surprising. As envisioned by the original IP designers, <span class="docEmphSmaller">TYPE OF SERVICE</span> would be an immutable quantity, and indeed worthy of protecting. It contained the desired routing metric and priority chosen by the source. But that use of the <span class="docEmphSmaller">TYPE OF SERVICE</span> field as originally defined in the IP header did not prove to be useful, and now network administrators are playing around with various uses of the field, such as categorizing the packet when it enters their domain. So routers today want to be free to modify that field.</p>
<p class="docText">Why is <span class="docEmphSmaller">PAYLOAD LENGTH</span> considered immutable? If a packet requires fragmentation, the <span class="docEmphSmaller">PAYLOAD LENGTH</span> must be modified (since <span class="docEmphSmaller">PAYLOAD LENGTH</span> is the length of the data in this fragment, not the original size of the packet as launched by the source), so it would seem like it should be considered mutable. However, the reason it can be considered immutable is that IP at the destination must reassemble the packet before AH can verify the integrity check, in which case although <span class="docEmphSmaller">PAYLOAD LENGTH</span> was modified en route, it has been restored to its original value before the AH header is processed. Theoretically the same logic would apply to <span class="docEmphSmaller">FRAGMENT OFFSET</span>, which should be set to <span class="docEmphRomanAlt">0</span> when launched by the source, and might be modified by routers along the path if the packet is fragmented, but will be restored to <span class="docEmphRomanAlt">0</span> again after the packet is reassembled at the destination, and before the AH header is processed. But AH has chosen to define <span class="docEmphSmaller">FRAGMENT OFFSET</span> as a mutable field, and therefore not covered by the AH integrity check. Not that it matters, since as we said earlier, there's no reason to bother protecting any of the IP header. Note that since <span class="docEmphSmaller">FRAGMENT OFFSET</span> is always <span class="docEmphRomanAlt">0</span> when the AH header is processed, whether it's immutable or not is irrelevant.</p>
<p class="docText">In IPv6 the mutable fields are <span class="docEmphSmaller">TYPE OF SERVICE</span> (because routers want to be able to modify it), <span class="docEmphSmaller">FLOW LABEL</span> (because the IPv6 designers still don't know what to do with the field, so maybe whatever they'll decide to use it for will require it to change en route), and <span class="docEmphSmaller">HOP LIMIT</span> (which is decremented by each router along the path).</p>
<a name="ch17lev2sec12"></a>
<h4 id="title-IDANYQ4R" class="docSection2Title">17.3.2. Mutable but Predictable</h4>
<p class="docText"><a name="iddle1671"></a>The <span class="docEmphSmaller">DESTINATION ADDRESS</span> is not quite considered immutable, but it is included in the AH integrity check, since there is one situation in which it might be modified in a way considered legitimate by the AH designers (as opposed to being modified by a NAT box, which the AH designers do not consider legitimate). This case is when the source specifies source routing as an option. The way source routing works in IP is that the source chooses a path consisting of a sequence of intermediate destinations to be visited in order, say D1, D2, D3, D, where D is the ultimate destination. In IPv4 there is an option called &quot;source routing&quot; that would include these intermediate destinations. In IPv6 it's an extension header called the &quot;route header&quot;, which is the same idea. When source routing is specified, the <span class="docEmphSmaller">DESTINATION ADDRESS</span> in the IP header (in both v4 and v6) specifies the next destination in the source route header, not the ultimate destination. So <span class="docEmphSmaller">DESTINATION ADDRESS</span> is clearly mutable, since in this example it would start out, when launched by S, as D1, get overwritten as D2 once it reached D1, get overwritten as D3 once it reached D2, and ultimately wind up at the destination as D.</p>
<a name="f434fig01"></a>
<p class="docText">
<img border="0" alt="" id="118095009249" width="300" height="134" src="434fig01.jpg" /></p>
<p class="docText">But the source knows what the <span class="docEmphSmaller">DESTINATION ADDRESS</span> will look like when it arrives at D (the <span class="docEmphSmaller">DESTINATION ADDRESS</span> field will specify D). So even though S launches it with <span class="docEmphSmaller">DESTINATION ADDRESS</span> set to D1, S computes the AH integrity check as though <span class="docEmphSmaller">DESTINATION ADDRESS</span> were set to D. Then when D evaluates the AH, it will compute properly as received.</p>
<p class="docText">So fields that are <span class="docEmphStrong">mutable but predictable</span> are included in the AH integrity check, but with the values they will have when received at the other end. The only one listed in the AH spec is the <span class="docEmphSmaller">DESTINATION ADDRESS</span>, but in theory the <span class="docEmphSmaller">TOTAL LENGTH</span> field in IPv4 should be listed as mutable but predictable rather than immutable, since if the packet were fragmented, that field would be modified en route, but would be restored by IP at the destination before IPsec at the destination saw the packet. But it isn't a problem since immutable and mutable-but-predictable fields are treated the same way at the destination.</p>
<ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="16051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch17lev1sec2.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch17lev1sec4.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>