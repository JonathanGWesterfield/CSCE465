<html><head><title>17.4. ESP (Encapsulating Security Payload)</title><title>TeamUnknown</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/globalstyle.css" /><link href="includes/searchResults.css" rel="stylesheet" type="text/css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/style.css" /><link rel="STYLESHEET" type="text/css" href="portals/bvdep/xsltemplates/docsafari.css" /><body><table width="100%" border="0" cellspacing="0" cellpadding="0"><td class="docBookTitle"><a href="toc.html"><b>[ Team Unknown ]</b></a></td></table><td align="center"><a name="MainContent"></a><table width="95%"><tr><td align="left" class="v2"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="16051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch17lev1sec3.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch17lev1sec5.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><div id="section"><br /><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td valign="top">Networking Security Networking Security Networking Security Security Networking Security Networking Security Networking Charlie Kaufman Radia Perlman Mike Speciner Prentice Hall Network Security: Private Communication in a Public World, Second Edition<a name="ch17lev1sec4"></a>
<h3 id="title-IDAHVC5F" class="docSection1Title">17.4. ESP (Encapsulating Security Payload)</h3>
<p class="docText">ESP allows for encryption and/or integrity protection. If you want encryption, you must use ESP. If you want integrity protection only, you could use ESP or AH. If you want both encryption and integrity protection, you could use both ESP and AH, or you could do both integrity protection and encryption with ESP. The security association database would tell you what to use when transmitting to a particular IP address. It's a little odd to call ESP a &quot;header&quot; because it puts information both before and after the encrypted data, but everyone seems to call it a header so we will too.</p>
<p class="docText">Technically, ESP always does encryption, but if you don't want encryption you use the special &quot;null encryption&quot; algorithm. The working group had a lot of fun writing the RFC specifying the null encryption algorithm, extolling its virtues like how fast it was and how it could take any size keys, and source and destination would even interoperate if they had different keys. For a bit of security-geek humor, read RFC 2410.</p>
<p class="docText">The presence of the ESP header is indicated by having the <span class="docEmphSmaller">PROTOCOL</span> field in IPv4 or the <span class="docEmphSmaller">NEXT HEADER</span> field in IPv6 equal to <span class="docEmphRomanAlt">50</span>. The ESP envelope itself consists of</p>
<p><table cellspacing="0" frame="void" rules="none" cellpadding="5"><colgroup align="right" span="2"><col width="50"></col><col width="400"></col></colgroup><thead></thead><tr><td class="docTableCell" align="right" valign="top"><p class="docText"># octets</p></td><td class="bottomBorder" align="right" valign="top">&nbsp;</td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">4</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">SPI (Security Parameters Index)</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">4</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">sequence number</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">variable</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">IV (initialization vector)</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">variable</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">data</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">variable</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">padding</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">1</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">padding length (in units of octets)</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">1</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">next header/protocol type</span></p></td></tr><tr><td class="rightBorder" align="right" valign="top"><p class="docText">variable</p></td><td class="rightBorder bottomBorder" align="center" valign="top"><p class="docText"><span class="docEmphRomanAlt">authentication data</span></p></td></tr></table></p><br />
<p class="docText">The fields are</p>
<ul><li><p class="docList"><span class="docEmphSmaller">SPI</span>. Same as for AH, discussed in &sect;<a class="docLink" href="ch17lev1sec1.html#ch17lev2sec1">17.1.1</a> <span class="docEmphasis">Security Associations</span>.</p></li><li><p class="docList"><span class="docEmphSmaller">SEQUENCE NUMBER</span>. Same as for AH, explained in &sect;<a class="docLink" href="ch17lev1sec3.html#ch17lev1sec3">17.3</a> <span class="docEmphasis">AH (Authentication Header)</span>.</p></li><li><p class="docList"><span class="docEmphSmaller">INITIALIZATION VECTOR</span>. An IV is required by some cryptographic algorithms, such as encryption with CBC mode. Although the IV is variable length (it may even be zero length), it's fixed length for a particular cryptographic algorithm. Once the SA is established, the cryptographic algorithm is known, and therefore the length of the IV field is fixed for the duration of the SA. This is also true of the field <span class="docEmphSmaller">AUTHENTICATION DATA</span>.</p></li><li><p class="docList"><span class="docEmphSmaller">DATA</span>. This is the protected data, probably encrypted. If it is a tunnel mode packet, then the beginning of the data would be an IP header. If it would have been TCP, and ESP is being used in Transport mode, then the beginning of the data would be the TCP header.</p></li><li><p class="docList"><span class="docEmphSmaller">PADDING</span>. Padding is used for several reasons: to make the data be a multiple of a block size for cryptographic algorithms that require it; to make the encrypted data be a different size than the plaintext, so as to somewhat disguise the size of the data (limited because <span class="docEmphSmaller">PADDING LENGTH</span> is only one octet); and to ensure that the combination of the fields <span class="docEmphSmaller">DATA</span>, <span class="docEmphSmaller">PADDING</span>, <span class="docEmphSmaller">PADDING LENGTH</span>, and <span class="docEmphSmaller">NEXT HEADER</span> are a multiple of four octets.</p></li><li><p class="docList"><span class="docEmphSmaller">PADDING LENGTH</span>. Number of octets of padding.</p></li><li><p class="docList"><span class="docEmphSmaller">NEXT HEADER</span>. Same as <span class="docEmphSmaller">PROTOCOL</span> field in IPv4 or <span class="docEmphSmaller">NEXT HEADER</span> in IPv6, or <span class="docEmphSmaller">NEXT HEADER</span> in AH.</p></li><li><p class="docList"><span class="docEmphSmaller">AUTHENTICATION DATA</span>. The cryptographic integrity check. Its length is determined by the authentication function selected for the SA; it is zero length if ESP is providing encryption only.</p></li></ul>
<p class="docText">If encryption is used, the fields <span class="docEmphSmaller">DATA</span>, <span class="docEmphSmaller">PADDING</span>, <span class="docEmphSmaller">PADDING LENGTH</span>, and <span class="docEmphSmaller">NEXT HEADER</span> are encrypted. The <span class="docEmphSmaller">AUTHENTICATION DATA</span> appears only if the security association requests integrity protection with ESP. If ESP integrity protection is used, all fields in the ESP (starting with SPI and ending with <span class="docEmphSmaller">NEXT HEADER</span>) are included in the ESP integrity check.</p>
<ul></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="middle" class="v2" height="5"><img src="pixel.gif" width="1" height="5" alt="" border="0" /></td></tr><tr><td valign="middle" class="v2"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td align="left"><span style="white-space:nowrap">&nbsp;</span>
                  &nbsp;
                  <span style="white-space:nowrap"> &nbsp;&nbsp;</span>
            &nbsp;<span style="white-space:nowrap">&nbsp;</span></td></tr></table></td><td></td><td valign="middle" class="v2" align="right"><a href="16051538.html"><img src="btn_next_.gif" width="1" height="1" alt="Next" border="0" /></a> 
          &nbsp;
          <span style="white-space:nowrap"><a target="_self" href="ch17lev1sec3.html" title="Previous section"><img border="0" align="absmiddle" src="btn_prev.gif" alt="Previous section" id="btn_prev" /></a></span>
				
				&nbsp;
				
				<span style="white-space:nowrap"><a target="_self" href="ch17lev1sec5.html" title="Next section"><img border="0" align="absmiddle" src="btn_next.gif" alt="Next section" id="btn_next" /></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2"><tr><td valign="top" align="right"><span style="white-space:nowrap"><a target="_self" href="#toppage" title="Top"></a></span></td></tr></table></div><!--IP User 2--></td></tr></table></td></body></head></html>